# Helm Suite - Caddy Reverse Proxy
# Binds to Tailscale IP + localhost only. Zero public exposure.
#
# Generated by setup.sh from .env configuration.
# Manual edits will be overwritten on next setup.sh run.

{
    default_bind ${TAILSCALE_IP} 127.0.0.1
}

# -- Snippets -----------------------------------------------------------------

(tls_config) {
    tls ${TLS_CERT_PATH} ${TLS_KEY_PATH}
}

(authelia) {
    forward_auth localhost:${AUTHELIA_PORT} {
        uri /api/verify?rd=https://auth.${DOMAIN}
        copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
    }
}

# -- Services -----------------------------------------------------------------

# Authelia SSO portal
auth.${DOMAIN} {
    import tls_config
    reverse_proxy localhost:${AUTHELIA_PORT}
}

# Gitea - Self-hosted Git
git.${DOMAIN} {
    import tls_config
    import authelia
    reverse_proxy localhost:${GITEA_HTTP_PORT}
}

# Immich - Photo management
photos.${DOMAIN} {
    import tls_config
    import authelia
    reverse_proxy localhost:${IMMICH_PORT}
}

# SearxNG - Private search
search.${DOMAIN} {
    import tls_config
    import authelia
    reverse_proxy localhost:${SEARXNG_PORT}
}

# Grafana - Monitoring dashboards
grafana.${DOMAIN} {
    import tls_config
    import authelia
    reverse_proxy localhost:${GRAFANA_PORT}
}

# Ollama - Local LLM API (no auth -- used by local tools)
ollama.${DOMAIN} {
    import tls_config
    reverse_proxy localhost:${OLLAMA_PORT}
}

# -- Redirects ----------------------------------------------------------------

# HTTP to HTTPS redirect for all subdomains
http://*.${DOMAIN} {
    bind ${TAILSCALE_IP} 127.0.0.1
    redir https://{host}{uri} permanent
}

# Catch-all for undefined subdomains
*.${DOMAIN} {
    import tls_config
    respond "Service not configured. Check your Helm Suite setup." 404
}
