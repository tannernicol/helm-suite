# Helm Suite — Caddy reverse proxy
#
# Binds to your Tailscale IP only. Nothing is reachable
# from the public internet.
#
# Replace {$DOMAIN} with your domain and {$TAILSCALE_IP}
# with your Tailscale address (e.g., 100.x.x.x).

{
	admin off
}

{$DOMAIN:example.com} {
	bind {$TAILSCALE_IP:127.0.0.1}
	tls internal

	# Authelia authentication portal
	handle /authelia/* {
		reverse_proxy authelia:9091
	}

	# Forward auth — all protected routes below use this
	@protected {
		not path /authelia/*
		not path /api/*
	}

	handle @protected {
		forward_auth authelia:9091 {
			uri /api/authz/forward-auth
			copy_headers Remote-User Remote-Groups Remote-Email
		}
	}

	# handle_path strips the prefix before forwarding to the backend.
	# e.g., /photos/api/albums → /api/albums on immich-server:2283

	# Immich — photo management
	handle_path /photos/* {
		reverse_proxy immich-server:2283
	}

	# Ollama — local LLM inference
	handle_path /ollama/* {
		reverse_proxy ollama:11434
	}

	# Gitea — git hosting (set GITEA__server__ROOT_URL in compose)
	handle_path /gitea/* {
		reverse_proxy gitea:3000
	}

	# SearxNG — private search
	handle_path /search/* {
		reverse_proxy searxng:8080
	}

	# Grafana — monitoring (set GF_SERVER_ROOT_URL in compose)
	handle_path /grafana/* {
		reverse_proxy grafana:3000
	}
}
