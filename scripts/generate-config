#!/usr/bin/env bash
set -euo pipefail

# =============================================================================
# Generate configs from .env
# Runs envsubst on all .template files and writes output to /srv/helm-suite
#
# Usage:
#     generate-config                 Generate all configs
#     generate-config --check         Check for missing variables
# =============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"
ENV_FILE="${REPO_DIR}/.env"

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m'

CHECK_ONLY=false
[[ "${1:-}" == "--check" ]] && CHECK_ONLY=true

# Load environment
if [[ ! -f "$ENV_FILE" ]]; then
    echo -e "${RED}.env file not found. Copy .env.example to .env first.${NC}"
    exit 1
fi

set -a
# shellcheck source=/dev/null
source "$ENV_FILE"
set +a

# Check for required variables
REQUIRED_VARS=(
    "DOMAIN"
    "TAILSCALE_IP"
    "USERNAME"
    "USER_EMAIL"
    "AUTHELIA_JWT_SECRET"
    "AUTHELIA_SESSION_SECRET"
    "AUTHELIA_STORAGE_ENCRYPTION_KEY"
)

echo -e "${BOLD}Checking required variables${NC}"
MISSING=0
for var in "${REQUIRED_VARS[@]}"; do
    val="${!var:-}"
    if [[ -z "$val" || "$val" == "CHANGE_ME"* ]]; then
        echo -e "  ${RED}[MISSING]${NC} ${var}"
        MISSING=$((MISSING + 1))
    else
        echo -e "  ${GREEN}[OK]${NC}      ${var}"
    fi
done

if [[ $MISSING -gt 0 ]]; then
    echo -e "\n${RED}${MISSING} required variable(s) not set in .env${NC}"
    exit 1
fi

if [[ "$CHECK_ONLY" == "true" ]]; then
    echo -e "\n${GREEN}All required variables are set.${NC}"
    exit 0
fi

# Generate configs
echo -e "\n${BOLD}Generating configs${NC}"

OUTPUT_DIR="/srv/helm-suite"
mkdir -p "$OUTPUT_DIR/caddy" "$OUTPUT_DIR/authelia"

# Caddyfile
envsubst < "${REPO_DIR}/infra/caddy/Caddyfile.template" > "${OUTPUT_DIR}/caddy/Caddyfile"
echo -e "  ${GREEN}[OK]${NC} Caddyfile"

# Authelia
envsubst < "${REPO_DIR}/infra/authelia/configuration.yml.template" > "${OUTPUT_DIR}/authelia/configuration.yml"
echo -e "  ${GREEN}[OK]${NC} Authelia configuration"

# MCP manifest
MCP_DIR="${REPO_DIR}/mcp"
export MCP_DIR
envsubst < "${REPO_DIR}/mcp/manifest.json.template" > "${OUTPUT_DIR}/mcp-manifest.json"
echo -e "  ${GREEN}[OK]${NC} MCP manifest"

echo -e "\n${GREEN}All configs generated in ${OUTPUT_DIR}${NC}"
