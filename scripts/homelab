#!/usr/bin/env bash
set -euo pipefail

# =============================================================================
# HelmV2 CLI -- Manage and monitor your homelab services
#
# Usage:
#     homelab status          Show status of all services
#     homelab ports           Show port allocations
#     homelab health          Run health checks on all services
#     homelab logs <service>  Tail logs for a service
#     homelab restart <svc>   Restart a Docker Compose service
# =============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"
ENV_FILE="${REPO_DIR}/.env"
COMPOSE_DIR="${REPO_DIR}/infra/compose"

# -- Colors -------------------------------------------------------------------
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

icon_ok="${GREEN}●${NC}"
icon_fail="${RED}●${NC}"
icon_warn="${YELLOW}●${NC}"
icon_off="${DIM}○${NC}"

# -- Helpers ------------------------------------------------------------------
load_env() {
    if [[ -f "$ENV_FILE" ]]; then
        set -a
        # shellcheck source=/dev/null
        source "$ENV_FILE"
        set +a
    fi
}

check_container() {
    local name="$1"
    local status
    status=$(docker inspect -f '{{.State.Status}}' "$name" 2>/dev/null || echo "not found")
    if [[ "$status" == "running" ]]; then
        echo -e "  ${icon_ok} ${name}"
        return 0
    else
        echo -e "  ${icon_fail} ${name} ${DIM}(${status})${NC}"
        return 1
    fi
}

check_port() {
    local port="$1"
    ss -tlnp "sport = :${port}" 2>/dev/null | grep -q "$port"
}

check_url() {
    local url="$1"
    curl -sf --max-time 3 "$url" >/dev/null 2>&1
}

# -- Commands -----------------------------------------------------------------
cmd_status() {
    load_env
    echo -e "\n${BOLD}HELMV2 STATUS${NC}"
    echo "$(printf '=%.0s' {1..55})"

    echo -e "\n${CYAN}Infrastructure${NC}"

    # Tailscale
    if tailscale status &>/dev/null 2>&1; then
        local ts_ip
        ts_ip=$(tailscale ip -4 2>/dev/null || echo "unknown")
        echo -e "  ${icon_ok} Tailscale          ${DIM}${ts_ip}${NC}"
    else
        echo -e "  ${icon_fail} Tailscale          ${DIM}not connected${NC}"
    fi

    # Caddy
    if systemctl is-active caddy-sovereign &>/dev/null 2>&1; then
        echo -e "  ${icon_ok} Caddy              ${DIM}reverse proxy${NC}"
    elif systemctl is-active caddy &>/dev/null 2>&1; then
        echo -e "  ${icon_ok} Caddy              ${DIM}reverse proxy${NC}"
    else
        echo -e "  ${icon_fail} Caddy              ${DIM}not running${NC}"
    fi

    # Docker
    if docker info &>/dev/null 2>&1; then
        local containers
        containers=$(docker ps -q 2>/dev/null | wc -l)
        echo -e "  ${icon_ok} Docker             ${DIM}${containers} containers${NC}"
    else
        echo -e "  ${icon_fail} Docker             ${DIM}not running${NC}"
    fi

    echo -e "\n${CYAN}Services${NC}"

    # Check each known service container
    local services=("ollama" "gitea" "searxng" "authelia" "grafana" "immich_server" "immich_machine_learning" "prometheus")
    for svc in "${services[@]}"; do
        check_container "$svc" || true
    done

    echo -e "\n${CYAN}Ports${NC}"
    local port_map=(
        "${OLLAMA_PORT:-11434}:Ollama"
        "${GITEA_HTTP_PORT:-3030}:Gitea"
        "${IMMICH_PORT:-2283}:Immich"
        "${SEARXNG_PORT:-8095}:SearxNG"
        "${AUTHELIA_PORT:-9091}:Authelia"
        "${GRAFANA_PORT:-3100}:Grafana"
    )
    for entry in "${port_map[@]}"; do
        local port="${entry%%:*}"
        local name="${entry#*:}"
        if check_port "$port"; then
            echo -e "  ${icon_ok} :${port}  ${name}"
        else
            echo -e "  ${icon_off} :${port}  ${name}  ${DIM}(not listening)${NC}"
        fi
    done

    echo ""
}

cmd_ports() {
    load_env
    echo -e "\n${BOLD}PORT ALLOCATION${NC}"
    echo "$(printf '=%.0s' {1..40})"

    local port_map=(
        "${AUTHELIA_PORT:-9091}:Authelia (SSO)"
        "${OLLAMA_PORT:-11434}:Ollama (LLM)"
        "${IMMICH_PORT:-2283}:Immich (Photos)"
        "${GITEA_HTTP_PORT:-3030}:Gitea HTTP (Git)"
        "${GITEA_SSH_PORT:-2222}:Gitea SSH"
        "${SEARXNG_PORT:-8095}:SearxNG (Search)"
        "${GRAFANA_PORT:-3100}:Grafana (Monitoring)"
        "${PROMETHEUS_PORT:-9090}:Prometheus (Metrics)"
    )

    for entry in "${port_map[@]}"; do
        local port="${entry%%:*}"
        local name="${entry#*:}"
        if check_port "$port"; then
            echo -e "  ${icon_ok} :${port}  ${name}"
        else
            echo -e "  ${icon_off} :${port}  ${name}"
        fi
    done
    echo ""
}

cmd_health() {
    load_env
    echo -e "\n${BOLD}HEALTH CHECKS${NC}"
    echo "$(printf '=%.0s' {1..40})"

    local pass=0
    local fail=0

    # Ollama
    printf "  %-20s " "Ollama API"
    if check_url "http://localhost:${OLLAMA_PORT:-11434}/api/tags"; then
        echo -e "${GREEN}OK${NC}"
        pass=$((pass + 1))
    else
        echo -e "${RED}FAIL${NC}"
        fail=$((fail + 1))
    fi

    # Gitea
    printf "  %-20s " "Gitea API"
    if check_url "http://localhost:${GITEA_HTTP_PORT:-3030}/api/v1/version"; then
        echo -e "${GREEN}OK${NC}"
        pass=$((pass + 1))
    else
        echo -e "${RED}FAIL${NC}"
        fail=$((fail + 1))
    fi

    # Immich
    printf "  %-20s " "Immich API"
    if check_url "http://localhost:${IMMICH_PORT:-2283}/api/server/ping"; then
        echo -e "${GREEN}OK${NC}"
        pass=$((pass + 1))
    else
        echo -e "${RED}FAIL${NC}"
        fail=$((fail + 1))
    fi

    # SearxNG
    printf "  %-20s " "SearxNG"
    if check_url "http://localhost:${SEARXNG_PORT:-8095}/healthz"; then
        echo -e "${GREEN}OK${NC}"
        pass=$((pass + 1))
    else
        echo -e "${RED}FAIL${NC}"
        fail=$((fail + 1))
    fi

    # Authelia
    printf "  %-20s " "Authelia"
    if check_url "http://localhost:${AUTHELIA_PORT:-9091}/api/health"; then
        echo -e "${GREEN}OK${NC}"
        pass=$((pass + 1))
    else
        echo -e "${RED}FAIL${NC}"
        fail=$((fail + 1))
    fi

    # Grafana
    printf "  %-20s " "Grafana"
    if check_url "http://localhost:${GRAFANA_PORT:-3100}/api/health"; then
        echo -e "${GREEN}OK${NC}"
        pass=$((pass + 1))
    else
        echo -e "${RED}FAIL${NC}"
        fail=$((fail + 1))
    fi

    echo ""
    echo -e "  ${GREEN}${pass} passed${NC}, ${RED}${fail} failed${NC}"
    echo ""

    return "$fail"
}

cmd_logs() {
    local service="${1:-}"
    if [[ -z "$service" ]]; then
        echo "Usage: homelab logs <service>"
        echo "Services: ollama, gitea, immich, searxng, authelia, grafana, monitoring"
        exit 1
    fi

    local compose_path="${COMPOSE_DIR}/${service}/docker-compose.yml"
    if [[ -f "$compose_path" ]]; then
        docker compose -f "$compose_path" logs -f --tail=50
    else
        # Try as a container name directly
        docker logs -f --tail=50 "$service" 2>/dev/null || \
            echo "Service not found: $service"
    fi
}

cmd_restart() {
    local service="${1:-}"
    if [[ -z "$service" ]]; then
        echo "Usage: homelab restart <service>"
        echo "Services: ollama, gitea, immich, searxng, authelia, monitoring"
        exit 1
    fi

    local compose_path="${COMPOSE_DIR}/${service}/docker-compose.yml"
    if [[ -f "$compose_path" ]]; then
        echo "Restarting ${service}..."
        docker compose -f "$compose_path" restart
        echo "Done."
    else
        echo "Service not found: $service"
        echo "Available: $(ls -1 "$COMPOSE_DIR" | tr '\n' ' ')"
        exit 1
    fi
}

cmd_help() {
    echo "HelmV2 CLI"
    echo ""
    echo "Usage: homelab <command> [args]"
    echo ""
    echo "Commands:"
    echo "  status              Show status of all services"
    echo "  ports               Show port allocations"
    echo "  health              Run health checks"
    echo "  logs <service>      Tail logs for a service"
    echo "  restart <service>   Restart a service"
    echo "  help                Show this help"
}

# -- Main ---------------------------------------------------------------------
case "${1:-status}" in
    status)  cmd_status ;;
    ports)   cmd_ports ;;
    health)  cmd_health ;;
    logs)    cmd_logs "${2:-}" ;;
    restart) cmd_restart "${2:-}" ;;
    help|--help|-h) cmd_help ;;
    *)
        echo "Unknown command: $1"
        cmd_help
        exit 1
        ;;
esac
