---
# Install Docker and optionally NVIDIA Container Toolkit

- name: Check if Docker is installed
  command: which docker
  register: docker_check
  ignore_errors: true
  changed_when: false

- name: Install Docker (apt)
  when: docker_check.rc != 0 and pkg_manager == "apt"
  block:
    - name: Install Docker packages
      apt:
        name:
          - docker.io
          - docker-compose-plugin
        state: present

- name: Install Docker (dnf)
  when: docker_check.rc != 0 and pkg_manager == "dnf"
  block:
    - name: Add Docker repo
      command: dnf config-manager --add-repo https://download.docker.com/linux/fedora/docker-ce.repo
      args:
        creates: /etc/yum.repos.d/docker-ce.repo

    - name: Install Docker packages
      dnf:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present

- name: Enable and start Docker
  systemd:
    name: docker
    state: started
    enabled: true

- name: Add user to docker group
  user:
    name: "{{ username }}"
    groups: docker
    append: true

# -- NVIDIA Container Toolkit (optional) --

- name: Check for NVIDIA GPU
  command: nvidia-smi
  register: nvidia_check
  ignore_errors: true
  changed_when: false

- name: Install NVIDIA Container Toolkit
  when: gpu_enabled | bool and nvidia_check.rc == 0
  block:
    - name: Check if nvidia-container-toolkit is installed
      command: which nvidia-ctk
      register: nct_check
      ignore_errors: true
      changed_when: false

    - name: Add NVIDIA Container Toolkit repo (apt)
      when: nct_check.rc != 0 and pkg_manager == "apt"
      block:
        - name: Add NVIDIA GPG key
          shell: |
            curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | \
              gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
          args:
            creates: /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg

        - name: Add NVIDIA repo
          shell: |
            curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
              sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
              tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
          args:
            creates: /etc/apt/sources.list.d/nvidia-container-toolkit.list

        - name: Install nvidia-container-toolkit
          apt:
            name: nvidia-container-toolkit
            state: present
            update_cache: true

    - name: Install nvidia-container-toolkit (dnf)
      when: nct_check.rc != 0 and pkg_manager == "dnf"
      block:
        - name: Add NVIDIA repo
          shell: |
            curl -s -L https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | \
              tee /etc/yum.repos.d/nvidia-container-toolkit.repo
          args:
            creates: /etc/yum.repos.d/nvidia-container-toolkit.repo

        - name: Install nvidia-container-toolkit
          dnf:
            name: nvidia-container-toolkit
            state: present

    - name: Configure Docker NVIDIA runtime
      command: nvidia-ctk runtime configure --runtime=docker
      notify: restart docker

- name: Verify Docker is working
  command: docker info
  register: docker_info
  changed_when: false
